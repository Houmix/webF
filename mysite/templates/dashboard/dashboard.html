{% extends "base.html" %}
{% load static %}

{% block title %} Acceuil - Dashboard {% endblock %}


{% block content %}
<!-- Main Content -->
<div class="hero-content">
    <h2>Mon Dashboard</h2>
    <div class="home-select">
        <form method="get">
            <label for="house_id">Choisissez une maison :</label>
            <select name="house_id" id="house_id" onchange="this.form.submit()">
                <option value="">-- S√©lectionnez une maison --</option>
                {% for house in houses %}
                <option value="{{ house.id }}" {% if house.id == selected_house.id %}selected{% endif %}>
                    {{ house.name }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="selected-house">
        {% if selected_house %}
            <h2 class="house-title">{{ selected_house.name }}</h2>
    
            {% if profile %}
                {% if profile.access %}

                    <h2>Annonces de la maison {{ selected_house.name }}</h2>
                    {% if news %}
                        <ul>
                            {% for item in news %}
                                <li>
                                    <h4>{{ item.title }}</h4>
                                    <p>{{ item.date }}</p>
                                    {% if item.photo %}
                                        <img src="{{ item.photo.url }}" alt="Photo de l'annonce" style="max-width: 200px;">
                                    {% endif %}
                                    <p>{{ item.content }}</p>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune annonce pour cette maison.</p>
                    {% endif %}                    
                    {% if profile.isOwner or profile.role == "admin" %}
                        <h3>Demandes en attente :</h3>
                        <ul>
                            {% for p in selected_house.profile_set.all %}
                                {% if not p.access %}
                                    <li>
                                        {{ p.user.username }}
                                        <form action="{% url 'AcceptAccess' selected_house.id p.user.id %}" method="post" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit">Accepter</button>
                                        </form>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}

                    <h3>Incidents</h3>
                    <ul>
                        {% for incident in incidents %}
                            <li>
                                <strong>{{ incident.description }}</strong> - {{ incident.date }}
                                {% if incident.response %}
                                    <p><em>R√©ponse : {{ incident.response }}</em></p>
                                {% elif profile.isOwner or profile.role == "admin" %}
                                    <form method="POST" action="{% url 'RespondIncident' incident.id %}">
                                        {% csrf_token %}
                                        <textarea name="response" rows="2" placeholder="Votre r√©ponse..."></textarea>
                                        <button type="submit">R√©pondre</button>
                                    </form>
                                {% else %}
                                    <p><em>En attente de r√©ponse...</em></p>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li>Aucun incident.</li>
                        {% endfor %}
                    </ul>
                    

                    <h3>Demandes de suppression projet</h3>
                    <ul>
                        {% for req in supp_asked %}
                            <li>
                                {{ req.user.username }} a demand√© la suppression de {{ req.house.name }}
                                <a href="{% url 'RequestSuppression' req.id '1' %}">ok</a>
                                <a href="{% url 'RequestSuppression' req.id '0' %}">Non</a>
                            </li>
                        {% empty %}
                            <li>Aucune demande de suppression.</li>
                        {% endfor %}
                    </ul>

                    <h3>Demandes de suppression objet</h3>
                    <ul>
                        {% for req in supp_entity_asked %}
                            <li>
                                {{ req.user.username }} a demand√© la suppression de {{ req.entity.name }} - {{ req.entity.house.name }}
                                <a href="{% url 'RequestSuppressionObject' req.id '1' %}">ok</a>
                                <a href="{% url 'RequestSuppressionObject' req.id '0' %}">Non</a>
                            </li>
                        {% empty %}
                            <li>Aucune demande de suppression.</li>
                        {% endfor %}
                    </ul>
                    

                    <!-- Bouton pour g√©n√©rer le rapport global -->
                    <a href="{% url 'generate_global_pdf' selected_house.id %}" class="btn btn-primary">üìÑ T√©l√©charger le rapport global PDF</a>

                    <!-- Inclure Chart.js -->
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                    <h3>Entit√©s</h3>

                    <!-- Barre de recherche -->
                    <div class="search-group">
                        <input type="text" id="entitySearch" placeholder="Rechercher une entit√©..." class="search-input" onkeyup="filterEntities()">
                    </div>

                    <ul id="entityList">
                        {% for entity in entities %}
                            <li class="entity-item">
                                <div>
                                    <p>{{ entity.name }}</p>
                                    <a href="{% url 'generate_entity_pdf' entity.id %}" class="btn btn-primary">G√©n√©rer PDF</a>
                                </div>
                                
                                <!-- Canvas pour les graphiques de chaque entit√© -->
                                <canvas id="chart_{{ forloop.counter }}" width="400" height="150"></canvas>
                                <canvas id="real_chart_{{ forloop.counter }}" width="400" height="150"></canvas>
                            </li>
                        {% endfor %}
                    </ul>

                    <h3>Graphiques de consommation</h3>

                    <!-- Graphique global -->
                    <canvas id="globalChart" width="600" height="300"></canvas>

                    <!-- Scripts pour les graphiques -->
                    <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        // Graphe global
                        const globalCtx = document.getElementById("globalChart").getContext("2d");
                        new Chart(globalCtx, {
                            type: 'bar',
                            data: {
                                labels: {{ global_flux_labels|safe }},
                                datasets: [{
                                    label: "Consommation totale",
                                    data: {{ global_flux_values|safe }},
                                    backgroundColor: "rgba(54, 162, 235, 0.6)"
                                }]
                            }
                        });

                        // Graphes par entit√©
                        {% for entity, data in flux_history_graph_data.items %}
                            const ctx{{ forloop.counter }} = document.getElementById("chart_{{ forloop.counter }}").getContext("2d");
                            new Chart(ctx{{ forloop.counter }}, {
                                type: 'bar',
                                data: {
                                    labels: {{ data.labels|safe }},
                                    datasets: [{
                                        label: "Consommation - {{ entity }}",
                                        data: {{ data.values|safe }},
                                        backgroundColor: "rgba(75, 192, 192, 0.5)"
                                    }]
                                }
                            });
                        {% endfor %}

                        // Historique r√©el par entit√©
                        {% for entity, data in real_history_graph_data.items %}
                            const realCtx{{ forloop.counter }} = document.getElementById("real_chart_{{ forloop.counter }}").getContext("2d");
                            new Chart(realCtx{{ forloop.counter }}, {
                                type: 'line',
                                data: {
                                    labels: {{ data.labels|safe }},
                                    datasets: [{
                                        label: "Historique - {{ entity }}",
                                        data: {{ data.values|safe }},
                                        borderColor: "rgba(255, 99, 132, 1)",
                                        fill: false
                                    }]
                                }
                            });
                        {% endfor %}
                    });
                    </script>

                    <script>
                    // Fonction de recherche d'entit√©s
                    function filterEntities() {
                        const input = document.getElementById("entitySearch").value.toLowerCase();
                        const entities = document.querySelectorAll("#entityList .entity-item");

                        entities.forEach(item => {
                            const text = item.textContent.toLowerCase();
                            item.style.display = text.includes(input) ? "" : "none";
                        });
                    }
                    </script>

    
                {% else %}
                    <p>‚õî Vous n'avez pas acc√®s √† cette maison.</p>
                {% endif %}
    
            {% else %}
                <p>Vous n'avez aucun profil pour cette maison.</p>
                <form method="post" action="{% url 'RequestAccess' selected_house.id %}">
                    {% csrf_token %}
                    <button class="auth-button">Demander l'acc√®s</button>
                </form>
            {% endif %}
        {% endif %}
    </div>
    
</div>
{% endblock %}